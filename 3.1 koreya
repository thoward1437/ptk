#!/bin/bash

# log_parser.sh: Парсинг и нормализация логов
NORMALIZED_FILE="/opt/security_system/normalized_logs.json"
RAW_LOG_DIR="/var/log/central_logs"

# Функция логирования
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [PARSER] $1" >> /var/log/security_parser.log
}

# Создаем директории если не существуют
mkdir -p "/opt/security_system" "$RAW_LOG_DIR"

# Очищаем старый файл
> "$NORMALIZED_FILE"

# Парсинг разных форматов
for log_file in "$RAW_LOG_DIR"/*.log; do
    if [[ -f "$log_file" ]]; then
        log "Processing $log_file"
        while IFS= read -r line; do
            # Пример парсинга syslog (формат: timestamp host program: message)
            if [[ "$line" =~ ^([0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}) ([^ ]+) ([^:]+): (.+)$ ]]; then
                timestamp="${BASH_REMATCH[1]}"
                host="${BASH_REMATCH[2]}"
                program="${BASH_REMATCH[3]}"
                message="${BASH_REMATCH[4]}"
                event_type="syslog"
            # Пример парсинга JSON (если логи в JSON)
            elif echo "$line" | jq . >/dev/null 2>&1; then
                timestamp=$(echo "$line" | jq -r '.timestamp // empty')
                host=$(echo "$line" | jq -r '.host // empty')
                program=$(echo "$line" | jq -r '.program // empty')
                message=$(echo "$line" | jq -r '.message // empty')
                event_type="json"
            else
                # Другие форматы (CSV и т.д.) - добавьте логику
                timestamp=$(date '+%Y-%m-%dT%H:%M:%S')
                host="unknown"
                program="unknown"
                message="$line"
                event_type="raw"
            fi

            # Нормализация в JSON
            jq -n --arg ts "$timestamp" --arg h "$host" --arg p "$program" --arg m "$message" --arg et "$event_type" \
               '{timestamp: $ts, host: $h, program: $p, message: $m, event_type: $et}' >> "$NORMALIZED_FILE"
        done < "$log_file"
    fi
done

log "Normalization complete"
